name: Website / Publish to Azure

on:
  # Automatically trigger it when detected changes in repo
  # for tagged releases matching 'v*.*.*'
  push:
    tags: [ 'v*.*.*', 'v*.*.*-*' ]
  # Allow manual trigger 
  workflow_dispatch:

jobs:
    build:
      runs-on: ubuntu-latest

      steps:
        - name: "Checkout GitHub Action"
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Get current ticks
          id: get_current_ticks
          shell: pwsh
          run: |
            $currentDateTimeTicks = [System.DateTimeOffset]::Now.UtcTicks
            "current_datetime_ticks=$($currentDateTimeTicks)" >> $env:GITHUB_ENV

        - name: Setup .NET SDK
          uses: actions/setup-dotnet@v3
          with:
            global-json-file: global.json

        - name: Install .NET tools
          run: dotnet tool restore

        - name: Update project files with gitversion
          run: dotnet tool run dotnet-gitversion /updateprojectfiles

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v2

        - name: Login to container registry
          uses: docker/login-action@v2
          with:
            registry: smallsonlinecontainerreg.azurecr.io
            username: ${{ secrets.REGISTRY_USERNAME }}
            password: ${{ secrets.REGISTRY_PASSWORD }}

        - name: Generate Docker metadata
          id: meta
          uses: docker/metadata-action@v4
          with:
            images: smallsonlinecontainerreg.azurecr.io/smallsonline-web-publicsite
            tags: |
              type=ref,event=tag
              type=ref,event=branch
              type=sha
              type=semver,pattern={{version}}
              type=semver,pattern={{major}}.{{minor}}

        - name: Get image tag
          id: imagetag
          shell: pwsh
          run: |
            $metaData = $env:DOCKER_METADATA_OUTPUT_JSON | ConvertFrom-Json
            $imageTag = $metaData.tags | Where-Object { $PSItem -like "*:v*" }
            "IMAGETAG=$($imageTag)" >> $env:GITHUB_ENV

        - name: Build and push container image to registry
          uses: docker/build-push-action@v4
          with:
            push: true
            file: ./Dockerfile.publicsite
            context: ./
            tags: ${{ steps.meta.outputs.tags }}
            labels: ${{ steps.meta.outputs.labels }}

        - name: Deploy to Azure Web App
          id: deploy-to-webapp
          uses: azure/webapps-deploy@v2
          with:
            app-name: 'smallsonline-web'
            slot-name: 'production'
            publish-profile: ${{ secrets.WEBSITE_AZUREAPPSVC_PUBLISHPROFILE }}
            images: ${{ env.IMAGETAG }}